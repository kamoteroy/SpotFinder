<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<title>PHYS</title>
	<link rel="stylesheet" href="../design/navbar.css">
	<link rel="icon" type="image/png" href="../design/icon.png">
	<script
			src="https://kit.fontawesome.com/fca84d70ac.js"
			crossorigin="anonymous"
		></script>
	<style>
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
		font-family: "Poppins", sans-serif;
	}
	body {
		background-image: url('../design/bg.jpg');
		height: 100vh;
		background-repeat: no-repeat;
		background-position: center;
		background-size: cover;
		display: flex;
    	flex-direction: column; /* Stack elements vertically */
    }
    h1 {
    	color: white;
    	font-size:20px;
    }
    .view {
    	left: 5vw;
    	width:95vw;
	    top: 15vh; /* Start from 15vh */
	    height: 85vh; /* The height of the view container */
	    display: flex;
	    flex-direction: row; /* Arrange items vertically */
	    box-sizing: border-box;
	    position: relative;
	}
	.widgets {
	    flex: 0 0 30%;
	    display: flex;         /* To center its content */
	    justify-content: center;
	    align-items: center;
	    flex-direction: column; /* Arrange items vertically */
	    gap: 40px;
	    padding: 40px;
	}
	.slot-counter {
		height: 300px;
		width: 300px;
		background-color: transparent;
		border: 2px solid rgba(255, 255, 255, 0.5);
		border-radius: 20px;
		backdrop-filter: blur(55px);
		padding: 2rem 3rem;
		transition: all 0.5s ease-in-out;
		display: flex;
		flex-direction: column;
		justify-content: space-around;
		align-content: center;
	}
	h1 {
		text-align: center; 
	}
	.motor-counter {
		height: 300px;
		width: 300px;
		background-color: transparent;
		border: 2px solid rgba(255, 255, 255, 0.5);
		border-radius: 20px;
		backdrop-filter: blur(55px);
		padding: 2rem 3rem;
		transition: all 0.5s ease-in-out;
		display: flex;
		flex-direction: column;
		justify-content: space-around;
		align-content: center;
		align-items: center;      /* Centers content vertically */
	}
	.counter-box { 
		height: 100px;
		width: 210px;
		background-color: rgba(255, 255, 255, 1);
		border: 2px solid rgba(255, 255, 255, 08.);
		border-radius: 20px;
		backdrop-filter: blur(55px);
		transition: all 1 ease-in-out;
		display: flex;
		flex-direction: column;
		align-items: center;
		overflow: hidden;
		overflow-y: hidden;
		overflow-y: auto;
		padding: 5px;
		font-size:55px;
		font-weight: bold;
	}
	.map {
	    width: 100%;
	    height: 100%;
	    background-repeat: no-repeat;
	    background-position: center;
	    background-size: contain;
	    transition: all 0.5s ease-in-out;
	    display: flex;
	    justify-content: center;  /* Center content horizontally */
	    align-items: center;      /* Center content vertically */
	    position: relative;       /* Allow for absolute positioning of children, if needed */
	    flex-direction :row;
	    gap:150px;
	}
	.map p{
	    font-size:40px;
	    position:absolute;
	}
	.map img{
		height:600px;
		width:450px;
	    position:absolute;
	}
	.map .button-row1, .button-row2 {
	  display: flex;                  /* Use Flexbox for the button rows */
	  justify-content: center;  /* Distribute buttons evenly */
	  align-items:center;
	  z-index: 10;                    /* Ensure buttons are on top of the image */
	  flex-direction :column;
	  gap:25px;
	  margin:0;
	  position:relative;
	  top:-5px;
	}
	.map-button-green, .map-button-red {
	    background-color: rgba(0, 0, 0, 0.5);
	    color: black;
	    font-size: 16px;
	    cursor: pointer;
	    z-index: 10;                    /* Ensure it's above other content */
	    height: 80px;
	    width: 90px;
	    transition: background-color 0.3s ease; /* Smooth transition on hover */
	    font-size: 0.8rem; /* Adjusts the font size */
	    background-color: rgba(0, 255, 0, 0.5); /* Light green background */
	    padding: 5px; /* Adds some padding */
	    border: 2px solid green; /* Red border */
	    border-radius: 3px; /* Slightly rounded corners */
		text-align: center;                /* Center the text */
	}
	.map-button-red {
	    background-color: rgba(255, 0, 0, 0.5); /* Light red background */
	    border: 2px solid #ff0000;              /* Red border */
	}
	.map-button:hover {
	    background-color: rgba(0, 0, 0, 0.7);
	}
	
	/* Optional: If you want to scale down the map and buttons when zooming out */
	@media (max-width: 1200px) {
	    .map-button {
	        transform: scale(0.8); /* Scale down the button */
	    }
	}
	.navbar .leftSide {
		margin-left:0px;
		flex: 40%;
		height: 100%;
		display: flex;
	}
	
	.navbar .rightSide {
		flex: 60%;
		justify-content: center;
		height: 100%;
		display: flex;
	}
	/* Modal styles */
	.modal {
	    display: none; /* Hidden by default */
	    position: fixed; /* Fixed position */
	    z-index: 100; /* Sit on top */
	    left: 0;
	    top: 0;
	    width: 100%; /* Full width */
	    height: 100%; /* Full height */
	    background-color: rgba(0, 0, 0, 0.5); /* Black background with opacity */
	}
	
	.modal-content {
	    background-color: white;
	    margin: 15% auto;
	    padding: 20px;
	    border-radius: 8px;
	    width: 300px;
	    text-align: center;
	}
	
	.close-button {
	    color: #aaa;
	    font-size: 28px;
	    font-weight: bold;
	    position: absolute;
	    top: 5px;
	    right: 10px;
	}
	
	.close-button:hover,
	.close-button:focus {
	    color: black;
	    text-decoration: none;
	    cursor: pointer;
	}
	
	.modal-actions {
	    display: flex;
	    justify-content: space-between;
	    margin-top: 20px;
	}
	
	button {
	    padding: 10px 20px;
	    border: none;
	    background-color: #4CAF50;
	    color: white;
	    cursor: pointer;
	    border-radius: 5px;
	}
	
	input[type="text"] {
	    padding: 8px;
	    margin: 10px 0;
	    border: 1px solid #ccc;
	    border-radius: 4px;
	    width: 100%;
	}
		
	</style>
</head>
	<body>
	<div class="navbar">
	        <div class="leftSide">
	            <div onclick="window.location.href='/map'" class="logo-button">
				</div>
	        </div>
	        <div class="rightSide">
	        	<a href="/">MAP</a>
	        	<a href="/socials">SOCIALS</a>
	            <a href="/about">ABOUT US </a>
	            <a href="/contact">CONTACT US </a>
	        </div>
	</div>
	<div class="dropdown">
		<input id="dropdown-toggle" class="dropdown-toggle">
		<label for="dropdown-toggle" class="dropdown-button" th:style="'background-image: url(' + ${user.getImg()} + ');'"></label>
		<div class="dropdown-content">
		<a href="/profile" class="profile-button">PROFILE</a>
		<a href="/history" class="profile-button">HISTORY</a>
		<a href="/signout" class="signout-button">SIGNOUT</a>
		</div>
	</div>
	    <div class="view">
    <div class="widgets">
        <div class="slot-counter">
            <h1>Parking Space Available :</h1>
            <div class="counter-box">
                <p id="availableCount"><span th:text="${parkingSlots.size() - occupiedCount}"></span></p>
            </div>
        </div>
        <div class="motor-counter">
            <h1>Motorcycle Count :</h1>
            <div class="counter-box">
                <p><span th:text="${parkingSlots.size() - occupiedCount}"></span></p>
            </div>
        </div>
    </div>

    <div class="map">
        <img src='../design/parkingportrait.png' alt="Image Description">
        <div class="button-row1">
            <button id="P1" class="map-button" 
				        th:class="${parkingSlotService.isOccupied('P1') ? 'map-button-red' : 'map-button-green'}"
				        onclick="openModal('P1')">P1</button>
				    <button id="P2" class="map-button" 
				        th:class="${parkingSlotService.isOccupied('P2') ? 'map-button-red' : 'map-button-green'}"
				        onclick="openModal('P2')">P2</button>
				    <button id="P3" class="map-button" 
				        th:class="${parkingSlotService.isOccupied('P3') ? 'map-button-red' : 'map-button-green'}"
				        onclick="openModal('P3')">P3</button>
				    <button id="P4" class="map-button" 
				        th:class="${parkingSlotService.isOccupied('P4') ? 'map-button-red' : 'map-button-green'}"
				        onclick="openModal('P4')">P4</button>
				    <button id="P5" class="map-button" 
				        th:class="${parkingSlotService.isOccupied('P5') ? 'map-button-red' : 'map-button-green'}"
				        onclick="openModal('P5')">P5</button>
        </div>

        <p>PHYS</p>

        <div class="button-row2">
            <button id="P6" 
                    th:class="${parkingSlotService.isOccupied('P6') ? 'map-button-red' : 'map-button-green'}"
                    onclick="openModal('P6')">P6</button>
            <button id="P7" 
                    th:class="${parkingSlotService.isOccupied('P7') ? 'map-button-red' : 'map-button-green'}"
                    onclick="openModal('P7')">P7</button>
            <button id="P8" 
                    th:class="${parkingSlotService.isOccupied('P8') ? 'map-button-red' : 'map-button-green'}"
                    onclick="openModal('P8')">P8</button>
            <button id="P9" 
                    th:class="${parkingSlotService.isOccupied('P9') ? 'map-button-red' : 'map-button-green'}"
                    onclick="openModal('P9')">P9</button>
            <button id="P10" 
                    th:class="${parkingSlotService.isOccupied('P10') ? 'map-button-red' : 'map-button-green'}"
                    onclick="openModal('P10')">P10</button>
        </div>
    </div>
</div>
<div id="modal" class="modal">
		    <div class="modal-content">
		        <span class="close-button">&times;</span>
		        <h2 id="modal-title">Parking Slot Details</h2>
		        <p id="modal-message">TAD</p>
		        <input type="text" id="username-input" placeholder="ID number" />
		        <div class="modal-actions">
		            <button id="confirm-btn">Confirm</button>
		            <button id="cancel-btn">Cancel</button>
		        </div>
		    </div>
		</div>
		<div id="error-modal" class="modal">
		    <div class="modal-content">
		        <span class="close-button" onclick="closeErrorModal()">&times;</span>
		        <h2>Error</h2>
		        <p id="error-message">You are not authorized to occupy this slot.</p>
		        <button onclick="closeErrorModal()">Close</button>
		    </div>
		</div>
		<script>
		// Get references to the modal elements
		const modal = document.getElementById('modal');
		const closeButton = document.querySelector('.close-button');
		const confirmButton = document.getElementById('confirm-btn');
		const cancelButton = document.getElementById('cancel-btn');
		const usernameInput = document.getElementById('username-input');
		const modalMessage = document.getElementById('modal-message');

		// Function to open the modal
		function openModal(slotName) {
		    console.log("Opening modal for slot:", slotName); // Debugging log
		    modal.style.display = "block"; // Show the modal
		    document.getElementById("modal-title").innerText = `TAP ID`;
		    modalMessage.innerText = ``;

		    // Handle confirm button click
		    confirmButton.onclick = function() {
		        const username = usernameInput.value.trim();
		        if (username) {
		            // Send the username and slot to the server via fetch
		            toggleOccupied(slotName, username);
		            modal.style.display = "none"; // Close the modal after submission
		        } else {
		            alert("Please enter a username.");
		        }
		    };

		    // Handle cancel button click
		    cancelButton.onclick = function() {
		        modal.style.display = "none"; // Close modal if cancel is clicked
		    };

		    // Handle close button click (X)
		    closeButton.onclick = function() {
		        modal.style.display = "none"; // Close modal if X is clicked
		    };

		    // Close modal if user clicks outside the modal content
		    window.onclick = function(event) {
		        if (event.target === modal) {
		            modal.style.display = "none"; // Close modal if clicked outside
		        }
		    };
		}

		// Function to handle unauthorized access error
		function showErrorModal(message) {
		    // Set the error message
		    document.getElementById("error-message").innerText = message;

		    // Show the error modal
		    document.getElementById("error-modal").style.display = "block";
		}

		// Function to close the error modal
		function closeErrorModal() {
		    document.getElementById("error-modal").style.display = "none";
		}

		function toggleOccupied(slotName, username) {
		    // Get the current date and time
		    // Get the current date and time in the local timezone
			const currentDate = new Date();
			
			// Get the hours, minutes, and seconds in local time (24-hour format)
			let hours = currentDate.getHours();  // Get hours (0-23)
			let minutes = currentDate.getMinutes();  // Get minutes (0-59)
			let seconds = currentDate.getSeconds();  // Get seconds (0-59)
			
			// Pad minutes and seconds with leading zeros if necessary
			hours = hours < 10 ? '0' + hours : hours;
			minutes = minutes < 10 ? '0' + minutes : minutes;
			seconds = seconds < 10 ? '0' + seconds : seconds;
			
			// Format the time in HH:mm:ss format
			const timeIn = `${hours}:${minutes}:${seconds}`;
			
			// Get the local date in YYYY-MM-DD format
			const date = currentDate.toLocaleDateString('en-CA');  // en-CA is YYYY-MM-DD format
			
			console.log("TimeIn: ", timeIn);  // Example: "10:30:00"
			console.log("Date: ", date);     // Example: "2024-11-28"


		    fetch(`/updateSlotStatus/${slotName}`, {
		        method: "POST",
		        headers: {
		            "Content-Type": "application/json"
		        },
		        body: JSON.stringify({
		            username: username,
		            slot: slotName,
		            timeIn: timeIn,  // Include timeIn
		            date: date       // Include date
		        })  // Sending username, slot, timeIn, and date
		    })
		    .then(response => {
		        if (response.status === 403) {
		            showErrorModal("User is not authorized to open this slot.");
		            return;
		        }

		        if (response.status === 409) {
		            showErrorModal("User is already parked in a slot.");
		            return;
		        }

		        return response.json();
		    })
		    .then(data => {
		        if (data) {
		            document.getElementById('availableCount').innerText = data;

		            let button = document.getElementById(slotName);
		            if (button.classList.contains('map-button-red')) {
		                button.classList.remove('map-button-red');
		                button.classList.add('map-button-green');
		            } else {
		                button.classList.remove('map-button-green');
		                button.classList.add('map-button-red');
		            }
		        }
		    })
		    .catch(error => console.error('Error:', error));
		}
</script>
</body>
</html>